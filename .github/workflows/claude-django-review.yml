name: Claude Django Code Review

on:
  workflow_call:
    inputs:
      model:
        description: 'Claude model to use for code review'
        required: false
        type: string
        default: 'claude-opus-4-5'
      review_language:
        description: 'Language for review output'
        required: false
        type: string
        default: 'Korean'
      trigger_label:
        description: 'Label name that triggers the review'
        required: false
        type: string
        default: 'ü§ñ AI Review'
    secrets:
      ANTHROPIC_API_KEY:
        required: true

jobs:
  claude-django-review:
    runs-on: ubuntu-latest
    if: github.event.action == 'labeled' && github.event.label.name == inputs.trigger_label
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Minimize previous PR comments
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            for (const comment of comments.data) {
              // Filter by comment content instead of user login
              if (comment.body && comment.body.includes('Claude Django Code Review')) {
                try {
                  await github.graphql(`
                    mutation {
                      minimizeComment(input: {subjectId: "${comment.node_id}", classifier: OUTDATED}) {
                        clientMutationId
                      }
                    }
                  `);
                  console.log(`Minimized comment ${comment.id} by ${comment.user.login}`);
                } catch (error) {
                  console.log(`Failed to minimize comment ${comment.id}: ${error.message}`);
                }
              }
            }

      - name: Generate Initial Django Code Review
        uses: anthropics/claude-code-action@v1
        timeout-minutes: 15
        continue-on-error: false
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are a senior Django backend engineer reviewing this PR. Read the project's CLAUDE.md file to understand conventions, then provide a thorough technical review.

            **Critical Analysis Areas (in priority order):**

            1. **Database Query Efficiency (HIGHEST PRIORITY):**
               - Trace complete query execution paths: ViewSet.queryset ‚Üí Serializer ‚Üí nested Serializers ‚Üí SerializerMethodField
               - Identify ALL N+1 queries by checking every ForeignKey/relation access
               - Verify select_related/prefetch_related coverage matches actual usage
               - Check for inefficient patterns: redundant queries, unnecessary count(), missing bulk operations
               - Analyze queryset usage in EACH view method separately
               - ‚ö†Ô∏è Test passing does NOT prove query efficiency!
               - If tests don't validate query counts, recommend adding django_assert_num_queries

            2. **Architecture (per project standards):**
               - Views: HTTP only, no business logic
               - Serializers: Validation + CRUD only
               - Usecases: Business logic
               - Tasks: Async operations
               - Flag violations as REQUEST_CHANGES

            3. **Security:**
               - Authentication/permission gaps
               - SQL injection, XSS risks
               - Sensitive data exposure

            4. **Test Quality:**
               - Exceptions: assert_exception_response(response, DrTailAPIException subclasses)
               - Enums: Use model enums, never hardcoded strings
               - Mocking: mocker: MockerFixture, verify with assert_called_once_with()
               - Coverage: All status codes (200, 400, 401, 403, 404)

            **Review Decision Criteria:**
            - Query inefficiency ‚Üí REQUEST_CHANGES
            - Architecture violation ‚Üí REQUEST_CHANGES
            - Security issue ‚Üí REQUEST_CHANGES
            - Minor improvements ‚Üí COMMENT
            - All good ‚Üí APPROVE

            **Output Requirements:**
            - Write entire review in ${{ inputs.review_language }}
            - Format each review item as a checkbox for easy tracking:
              * Use `- [ ] Issue description` format for actionable items
              * Group related items under category headings (e.g., "### Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏøºÎ¶¨ Ïù¥Ïäà")
              * Include file:line references in each checkbox item
              * Example format:
                ```
                ### Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÏøºÎ¶¨ Ïù¥Ïäà
                - [ ] consultation/views.py:45 - select_related('user') Ï∂îÍ∞ÄÌïòÏó¨ N+1 ÏøºÎ¶¨ Ìï¥Í≤∞
                - [ ] pet/serializers.py:123 - ÎπÑÌö®Ïú®Ï†ÅÏù∏ queryset iteration ÏàòÏ†ï

                ### ÏïÑÌÇ§ÌÖçÏ≤ò Ïù¥Ïäà
                - [ ] consultation/views.py:89 - ÎπÑÏ¶àÎãàÏä§ Î°úÏßÅÏùÑ usecases.pyÎ°ú Ïù¥Îèô
                ```
            - Do NOT mention "CLAUDE.md" in your review output
            - Explain conventions directly as standard practices
            - Provide concrete code examples where helpful
            - For query issues, trace the complete execution path with line numbers

            Save your ${{ inputs.review_language }} review to a file named '.claude-code-review-initial.md' using Write tool. Do NOT post to PR yet.

          claude_args: '--model ${{ inputs.model }} --allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Write,Read,Glob,Grep"'

      - name: Verify Review Completeness
        uses: anthropics/claude-code-action@v1
        timeout-minutes: 15
        continue-on-error: false
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are a senior review auditor. Your task is to verify that the initial code review is complete and thorough.

            **Verification Checklist:**

            1. Read the initial review from '.claude-code-review-initial.md'
            2. Read the PR diff and compare against the review
            3. Check if the review covers ALL these critical areas:
               - Database query efficiency (N+1 queries, select_related/prefetch_related)
               - Architecture violations (business logic in views, etc.)
               - Security issues
               - Test quality and coverage
            4. Identify any missed critical issues:
               - Files that were changed but not reviewed
               - Database queries that weren't analyzed
               - Missing security checks
               - Incomplete test coverage analysis
            5. Check review quality:
               - Specific file:line references provided
               - Concrete code examples given
               - Clear decision (APPROVE/COMMENT/REQUEST_CHANGES)

            **Your Actions:**
            - If review is incomplete or missed critical issues:
              * Add ONLY the missing review findings to '.claude-code-review-additional.md'
              * Create '.claude-code-review-verification.md' with your verification report (for internal logging only)
            - If review is thorough and complete:
              * Create '.claude-code-review-verification.md' with verification confirmation (for internal logging only)
            - Create '.claude-code-review-final.md' with ONLY the technical review content (initial + additional findings if any)
            - DO NOT include verification results, meta-commentary, or "Î¶¨Î∑∞ Í≤ÄÏ¶ù Í≤∞Í≥º" sections in the final.md

            **Output Requirements:**
            - All content must be in ${{ inputs.review_language }}
            - Use file:line format
            - Be specific about what was missed (if anything)
            - Keep verification results separate from technical review content

          claude_args: '--model ${{ inputs.model }} --allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Read,Write,Glob,Grep"'

      - name: Post Final Review to PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read the final review (technical content only)
            let finalReview;
            try {
              finalReview = fs.readFileSync('.claude-code-review-final.md', 'utf8');
            } catch (error) {
              console.error('Failed to read .claude-code-review-final.md:', error);
              core.setFailed('Review file not found. Claude review may have failed.');
              return;
            }

            // Log verification results to Actions (not posted to PR)
            if (fs.existsSync('.claude-code-review-verification.md')) {
              const verification = fs.readFileSync('.claude-code-review-verification.md', 'utf8');
              console.log('=== Internal Verification Report ===');
              console.log(verification);
              console.log('===================================');
            }

            // Check if there were additional findings
            let reviewStatus = '‚úÖ Î¶¨Î∑∞ ÏôÑÎ£å';
            if (fs.existsSync('.claude-code-review-additional.md')) {
              reviewStatus = '‚ö†Ô∏è Ï∂îÍ∞Ä Ïù¥Ïäà Î∞úÍ≤¨';
              console.log('Additional issues were found during verification');
            }

            // Post the review as a comment (technical content only, no verification meta-info)
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## Claude Django Code Review ${reviewStatus}\n\n${finalReview}`
            });

            console.log('Review posted successfully');

      - name: Remove AI Review label
        if: success() && github.event.action == 'labeled'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                name: '${{ inputs.trigger_label }}'
              });
              console.log('Removed "${{ inputs.trigger_label }}" label after successful review');
            } catch (error) {
              console.log(`Failed to remove label: ${error.message}`);
            }

      - name: Cleanup review files
        if: always()
        run: |
          rm -f .claude-code-review-*.md .claude-code-review-*.txt
          echo "Cleaned up review files"
