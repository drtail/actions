name: 'Claude Django Code Review'
description: 'AI-powered Django code review using Claude'
author: 'drtail'

inputs:
  anthropic_api_key:
    description: 'Anthropic API Key'
    required: true
  github_token:
    description: 'GitHub Token for PR operations'
    required: true
  model:
    description: 'Claude model to use for code review'
    required: false
    default: 'claude-sonnet-4-6'
  review_language:
    description: 'Language for review output'
    required: false
    default: 'Korean'
  trigger_label:
    description: 'Label name that triggers the review'
    required: false
    default: 'ğŸ¤– AI Review'

runs:
  using: 'composite'
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1

    - name: Minimize previous PR comments
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const comments = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number
          });

          for (const comment of comments.data) {
            if (comment.body && comment.body.includes('Claude Django Code Review')) {
              try {
                await github.graphql(`
                  mutation {
                    minimizeComment(input: {subjectId: "${comment.node_id}", classifier: OUTDATED}) {
                      clientMutationId
                    }
                  }
                `);
                console.log(`Minimized comment ${comment.id} by ${comment.user.login}`);
              } catch (error) {
                console.log(`Failed to minimize comment ${comment.id}: ${error.message}`);
              }
            }
          }

    - name: Generate Initial Django Code Review
      uses: anthropics/claude-code-action@v1.0.55
      with:
        anthropic_api_key: ${{ inputs.anthropic_api_key }}
        show_full_output: true
        prompt: |
          REPO: ${{ github.repository }}
          PR NUMBER: ${{ github.event.pull_request.number }}

          You are a senior Django backend engineer reviewing this PR. Read the project's CLAUDE.md file to understand conventions, then provide a thorough technical review.

          **Critical Analysis Areas (in priority order):**

          1. **Database Query Efficiency (HIGHEST PRIORITY):**
             - Trace complete query execution paths: ViewSet.queryset â†’ Serializer â†’ nested Serializers â†’ SerializerMethodField
             - Identify ALL N+1 queries by checking every ForeignKey/relation access
             - Verify select_related/prefetch_related coverage matches actual usage
             - Check for inefficient patterns: redundant queries, unnecessary count(), missing bulk operations
             - Analyze queryset usage in EACH view method separately
             - âš ï¸ Test passing does NOT prove query efficiency!
             - If tests don't validate query counts, recommend adding django_assert_num_queries

          2. **Architecture (per project standards):**
             - Views: HTTP only, no business logic
             - Serializers: Validation + CRUD only
             - Usecases: Business logic
             - Tasks: Async operations
             - Flag violations as REQUEST_CHANGES

          3. **Security:**
             - Authentication/permission gaps
             - SQL injection, XSS risks
             - Sensitive data exposure

          4. **Test Quality:**
             - Exceptions: assert_exception_response(response, DrTailAPIException subclasses)
             - Enums: Use model enums, never hardcoded strings
             - Mocking: mocker: MockerFixture, verify with assert_called_once_with()
             - Coverage: All status codes (200, 400, 401, 403, 404)

          **Priority Levels (Pn Rule):**
          - **P1**: Critical bugs - security vulnerabilities, data loss, crashes (MUST fix)
          - **P2**: Convention violations, performance issues requiring improvement (SHOULD fix)
          - **P3**: Suggested improvements, better practices (COULD fix)
          - **P4**: Minor suggestions, style preferences (CONSIDER)
          - **P5**: Nitpicks, optional enhancements (FYI)

          **Review Decision Criteria:**
          - P1 or P2 issues found â†’ REQUEST_CHANGES
          - Only P3-P5 issues found â†’ COMMENT
          - All good â†’ APPROVE

          **Output Requirements:**
          - Write entire review in ${{ inputs.review_language }}
          - Start with review decision header (## âŒ REQUEST CHANGES / ## ğŸ’¬ COMMENT / ## âœ… APPROVED)
          - Format each review item with the following structure:
            * `[Pn]` badge + descriptive title summarizing the issue
            * Include file:line reference and detailed explanation in the body
            * Group related items under category headings
          - End with conclusion section restating the decision
          - Example format:
              ```
              ## âŒ REQUEST CHANGES

              ì´ PRì—ëŠ” ë°˜ë“œì‹œ ìˆ˜ì •ì´ í•„ìš”í•œ P1/P2 ì´ìŠˆê°€ ìˆìŠµë‹ˆë‹¤.

              ---

              ### ë°ì´í„°ë² ì´ìŠ¤ ì¿¼ë¦¬ ì´ìŠˆ

              `[P2]` **select_related ëˆ„ë½ìœ¼ë¡œ ì¸í•œ N+1 ì¿¼ë¦¬**
              `consultation/views.py:45` - User ì¡°íšŒ ì‹œ select_related('user') ì¶”ê°€ í•„ìš”

              `[P2]` **ë¹„íš¨ìœ¨ì ì¸ queryset iteration**
              `pet/serializers.py:123` - list comprehension ëŒ€ì‹  values_list ì‚¬ìš© ê¶Œì¥

              ### ì•„í‚¤í…ì²˜ ì´ìŠˆ

              `[P2]` **Viewì— ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ í¬í•¨**
              `consultation/views.py:89` - ê²°ì œ ì²˜ë¦¬ ë¡œì§ì„ usecases.pyë¡œ ì´ë™ í•„ìš”

              ### ê°œì„  ì œì•ˆ

              `[P3]` **ìºì‹± ë¯¸ì ìš©**
              `utils/helpers.py:20` - ìì£¼ í˜¸ì¶œë˜ëŠ” ì„¤ì •ê°’ì— ìºì‹± ì ìš© ê³ ë ¤

              ---

              ## ê²°ë¡ : âŒ REQUEST CHANGES

              P2 ì´ìŠˆ 3ê±´ì´ ë°œê²¬ë˜ì–´ ìˆ˜ì • í›„ ì¬ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤.
              ```
          - Do NOT mention "CLAUDE.md" in your review output
          - Explain conventions directly as standard practices
          - Provide concrete code examples where helpful
          - For query issues, trace the complete execution path with line numbers

          Save your ${{ inputs.review_language }} review to a file named '.claude-code-review-initial.md' using Write tool. Do NOT post to PR yet.

        claude_args: '--model ${{ inputs.model }} --allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr list:*),Write,Read,Glob,Grep"'

    - name: Verify Review Completeness
      uses: anthropics/claude-code-action@v1.0.55
      with:
        anthropic_api_key: ${{ inputs.anthropic_api_key }}
        show_full_output: true
        prompt: |
          REPO: ${{ github.repository }}
          PR NUMBER: ${{ github.event.pull_request.number }}

          You are a senior review auditor. Your task is to verify that the initial code review is complete and thorough.

          **Verification Checklist:**

          1. Read the initial review from '.claude-code-review-initial.md'
          2. Read the PR diff and compare against the review
          3. Check if the review covers ALL these critical areas:
             - Database query efficiency (N+1 queries, select_related/prefetch_related)
             - Architecture violations (business logic in views, etc.)
             - Security issues
             - Test quality and coverage
          4. Identify any missed critical issues:
             - Files that were changed but not reviewed
             - Database queries that weren't analyzed
             - Missing security checks
             - Incomplete test coverage analysis
          5. Check review quality:
             - Specific file:line references provided
             - Concrete code examples given
             - Clear decision (APPROVE/COMMENT/REQUEST_CHANGES)

          **Your Actions:**
          - If review is incomplete or missed critical issues:
            * Add ONLY the missing review findings to '.claude-code-review-additional.md'
            * Create '.claude-code-review-verification.md' with your verification report (for internal logging only)
          - If review is thorough and complete:
            * Create '.claude-code-review-verification.md' with verification confirmation (for internal logging only)
          - Create '.claude-code-review-final.md' with ONLY the technical review content (initial + additional findings if any)
          - DO NOT include verification results, meta-commentary, or "ë¦¬ë·° ê²€ì¦ ê²°ê³¼" sections in the final.md

          **Output Requirements:**
          - All content must be in ${{ inputs.review_language }}
          - Use file:line format
          - Be specific about what was missed (if anything)
          - Keep verification results separate from technical review content

        claude_args: '--model ${{ inputs.model }} --allowed-tools "Bash(gh pr diff:*),Bash(gh pr view:*),Read,Write,Glob,Grep"'

    - name: Post Final Review to PR
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const fs = require('fs');

          let finalReview;
          try {
            finalReview = fs.readFileSync('.claude-code-review-final.md', 'utf8');
          } catch (error) {
            console.error('Failed to read .claude-code-review-final.md:', error);
            core.setFailed('Review file not found. Claude review may have failed.');
            return;
          }

          if (fs.existsSync('.claude-code-review-verification.md')) {
            const verification = fs.readFileSync('.claude-code-review-verification.md', 'utf8');
            console.log('=== Internal Verification Report ===');
            console.log(verification);
            console.log('===================================');
          }

          let reviewStatus = 'âœ… ë¦¬ë·° ì™„ë£Œ';
          if (fs.existsSync('.claude-code-review-additional.md')) {
            reviewStatus = 'âš ï¸ ì¶”ê°€ ì´ìŠˆ ë°œê²¬';
            console.log('Additional issues were found during verification');
          }

          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `## Claude Django Code Review ${reviewStatus}\n\n${finalReview}`
          });

          console.log('Review posted successfully');

    - name: Remove AI Review label
      if: success()
      uses: actions/github-script@v7
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          try {
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: '${{ inputs.trigger_label }}'
            });
            console.log('Removed "${{ inputs.trigger_label }}" label after successful review');
          } catch (error) {
            console.log(`Failed to remove label: ${error.message}`);
          }

    - name: Cleanup review files
      if: always()
      shell: bash
      run: |
        rm -f .claude-code-review-*.md .claude-code-review-*.txt
        echo "Cleaned up review files"
